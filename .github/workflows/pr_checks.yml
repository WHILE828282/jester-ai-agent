name: PR checks

# Запуск на открытие/обновление/переоткрытие PR
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  checks:
    name: Run checks (build / lint / test / audit / secret-scan)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js (cache npm)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build (if present)
        run: npm run build --if-present

      - name: Lint (if present)
        run: npm run lint --if-present

      - name: Run tests
        run: npm test
        env:
          CI: true

      - name: NPM audit (fail on moderate+)
        # Fail the job if audit finds vulnerabilities above the threshold
        run: |
          set -e
          npm audit --audit-level=moderate || (echo "npm audit found issues >= moderate" && exit 1)

      - name: Secret scan (gitleaks)
        # Gitleaks scans repo and will fail CI if secrets found
        uses: zricethezav/gitleaks-action@v2
        with:
          args: --no-git -v
